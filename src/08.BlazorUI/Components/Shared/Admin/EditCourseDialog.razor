@using MudBlazor
@using MyApp.BlazorUI.DTOs
@using MyApp.BlazorUI.Services
@using Microsoft.AspNetCore.Components.Forms
@using MyApp.BlazorUI.Components.Models
@using System.Globalization

<MudDialog MaxWidth="MaxWidth.Small" FullWidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">Edit Course</MudText>
    </TitleContent>

    <DialogContent>
        <MudPaper Elevation="0" Class="dialog-body">
            <MudForm @ref="_form" @bind-IsValid="_isFormValid" ValidationDelay="100">
                <div class="form-grid">
                    <!-- Nama -->
                    <MudTextField T="string" Label="Nama Course" @bind-Value="_editCourse.Name" Required="true"
                        RequiredError="Nama wajib diisi" />

                    <!-- Deskripsi -->
                    <MudTextField T="string" Label="Deskripsi" @bind-Value="_editCourse.Description" Lines="3"
                        Required="true" RequiredError="Deskripsi wajib diisi" />

                    <!-- Harga -->
                    <MudNumericField T="decimal" Label="Harga" Value="_editCourse.Price"
                        ValueChanged="val => _editCourse.Price = val" ValueExpression="@(() => _editCourse.Price)"
                        Immediate="true" Adornment="Adornment.Start" AdornmentText="Rp" Required="true"
                        RequiredError="Harga wajib diisi" Culture="@_idCulture" DecimalPlaces="0" />

                    <!-- Kategori -->
                    <MudSelect T="int" Label="Kategori" @bind-Value="_editCourse.CategoryId" Required="true"
                        RequiredError="Kategori wajib dipilih">
                        @foreach (var cat in Categories)
                        {
                            <MudSelectItem Value="@cat.Id">@cat.Name</MudSelectItem>
                        }
                    </MudSelect>

                    <!-- Upload Gambar & Preview -->
                    <div class="file-section">
                        <MudText Typo="Typo.body2">Upload Gambar (opsional)</MudText>
                        <InputFile OnChange="OnFileSelected" accept="image/*" />
                        @if (_selectedFile != null)
                        {
                            <MudText Typo="Typo.caption">File: @_selectedFile.Name (@(_selectedFile.Size / 1024) KB)
                            </MudText>
                        }
                        else if (!string.IsNullOrEmpty(_imagePreview))
                        {
                            <div style="margin-top:0.5rem;">
                                <MudAvatar Size="Size.Medium" Image="@_imagePreview" />
                            </div>
                        }
                    </div>
                </div>
            </MudForm>
        </MudPaper>
    </DialogContent>

    <DialogActions>
        <div class="actions">
            <MudButton OnClick="Cancel" Variant="Variant.Outlined" Color="Color.Secondary">Batal</MudButton>
            <MudButton OnClick="SubmitAsync" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_isFormValid)">
                Simpan Perubahan
            </MudButton>
        </div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] private CourseService CourseService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    [Parameter] public List<CategoryDto> Categories { get; set; } = new();
    [Parameter] public CourseModel CourseToEdit { get; set; } = new();

    private MudForm? _form;
    private bool _isFormValid;
    private CreateCourseDto _editCourse = new();
    private IBrowserFile? _selectedFile;
    private string? _imagePreview;

    // CultureInfo disiapkan di code-behind, agar atribut Razor tidak perlu escaping
    private readonly CultureInfo _idCulture = new("id-ID");

    protected override void OnInitialized()
    {
        // Isi DTO awal supaya field (termasuk numeric) langsung berisi value
        _editCourse = new CreateCourseDto
        {
            Name = CourseToEdit.Name,
            Description = CourseToEdit.Description,
            Price = CourseToEdit.Price,
            CategoryId = CourseToEdit.CategoryId
        };

        _imagePreview = CourseToEdit.ImageUrl;
    }

    private void Cancel() => MudDialog.Cancel();

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
    }

    private async Task SubmitAsync()
    {
        // Pastikan form valid
        await _form!.Validate();
        if (!_isFormValid)
        {
            Snackbar.Add("Periksa kembali form Anda.", Severity.Warning);
            return;
        }

        var updated = await CourseService.UpdateCourseAsync(CourseToEdit.Id, _editCourse, _selectedFile);

        if (updated)
        {
            Snackbar.Add("âœ… Perubahan course berhasil disimpan.", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            Snackbar.Add("Gagal menyimpan perubahan course.", Severity.Error);
        }
    }
}