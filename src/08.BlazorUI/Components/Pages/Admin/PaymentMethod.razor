@page "/admin-payment"
@using MyApp.BlazorUI.Components.Models
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Shared.Admin
@layout AdminLayout

@inject IDialogService DialogService
@inject PaymentService PaymentService
@inject ISnackbar Snackbar

<PageTitle>Payment Method</PageTitle>

<MudPaper Class="payment-container" Elevation="1">
  <div class="header-section">
    <MudText Typo="Typo.h5" Class="title">Payment Method</MudText>
    <MudButton OnClick="OpenDialogAddPaymentAsync" Variant="Variant.Filled" Color="Color.Success"
      StartIcon="@Icons.Material.Filled.Add">
      Add Payment Method
    </MudButton>
  </div>

  <MudTable Items="@Payments" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
    LoadingProgressColor="Color.Info" Class="payment-table" RowsPerPage="5">

    <HeaderContent>
      <MudTh class="text-center">Id</MudTh>
      <MudTh class="text-center">Name</MudTh>
      <MudTh class="text-center">Logo</MudTh>
      <MudTh class="text-center">Status</MudTh>
      <MudTh class="text-center">Action</MudTh>
    </HeaderContent>

    <RowTemplate>
      <MudTd DataLabel="Id">@context.Id</MudTd>
      <MudTd DataLabel="Name">@context.Name</MudTd>
      <MudTd DataLabel="Logo">
        @if (!string.IsNullOrEmpty(context.Logo))
        {
          <MudImage Src="@PaymentService.GetFullImageUrl(context.Logo)" Alt="@context.Name" Width="40" Height="40"
            Class="rounded" />
        }
        else
        {
          <MudIcon Icon="@Icons.Material.Filled.ImageNotSupported" Color="Color.Default" />
        }
      </MudTd>
      <MudTd DataLabel="Status">
        @if (context.Status == PaymentStatus.Active)
        {
          <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">Active</MudChip>
        }
        else
        {
          <MudChip T="string" Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">Inactive</MudChip>
        }
      </MudTd>
      <MudTd DataLabel="Action">
        <div class="action-buttons">
          <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning"
            OnClick="@(() => OpenDialogEditPaymentAsync(context))" Title="Edit" />
          <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
            OnClick="@(() => DeletePaymentAsync(context))" Title="Delete" />
        </div>
      </MudTd>
    </RowTemplate>

    <PagerContent>
      <MudTablePager PageSizeOptions="new int[] { 5, 10, 25, 50 }" />
    </PagerContent>
  </MudTable>
</MudPaper>

@code {
  private bool _loading;
  private List<PaymentModel> Payments = new();

  protected override async Task OnInitializedAsync() => await LoadPaymentsAsync();

  private async Task LoadPaymentsAsync()
  {
    _loading = true;
    try
    {
      Payments = await PaymentService.GetPaymentsAsync();
    }
    catch (Exception ex)
    {
      Snackbar.Add($"❌ Failed to load payments: {ex.Message}", Severity.Error);
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }

  private async Task OpenDialogAddPaymentAsync()
  {
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
    var dialog = await DialogService.ShowAsync<AddPaymentDialog>("Add Payment", options: options);
    var result = await dialog.Result;

    if (result?.Data is true)
    {
      Snackbar.Add("✅ Payment method added successfully.", Severity.Success);
      await LoadPaymentsAsync();
    }
  }

  private async Task OpenDialogEditPaymentAsync(PaymentModel payment)
  {
    var parameters = new DialogParameters { { "Payment", payment } };
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

    var dialog = await DialogService.ShowAsync<EditPaymentDialog>("Edit Payment", parameters, options);
    var result = await dialog.Result;

    if (result?.Data is true)
    {
      Snackbar.Add($"✅ Payment '{payment.Name}' updated successfully.", Severity.Success);
      await LoadPaymentsAsync();
    }
  }

  private async Task DeletePaymentAsync(PaymentModel payment)
  {
    bool confirmed = await DialogService.ShowMessageBox(
    "Confirm Delete",
    $"Are you sure you want to delete {payment.Name}?",
    yesText: "Yes", noText: "Cancel") ?? false;

    if (!confirmed)
      return;

    try
    {
      if (await PaymentService.DeletePaymentAsync(payment.Id))
      {
        Snackbar.Add($"✅ Payment '{payment.Name}' deleted successfully.", Severity.Success);
        await LoadPaymentsAsync();
      }
      else
      {
        Snackbar.Add($"⚠️ Failed to delete '{payment.Name}'.", Severity.Warning);
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add($"❌ Error deleting payment: {ex.Message}", Severity.Error);
    }
  }
}

<style>
  .payment-container {
    padding: 1.5rem;
    background-color: #fff;
    border-radius: 12px;
    overflow-x: auto;
    box-sizing: border-box;
  }

  .header-section {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .payment-table {
    width: 100%;
  }

  .action-buttons {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .mud-table-head th {
    background-color: #e8f5e9 !important;
    font-weight: 600;
    text-align: center;
  }

  @@media (max-width: 768px) {
    .payment-container {
      padding: 1rem;
    }

    .header-section {
      flex-direction: column;
      align-items: stretch;
    }

    .header-section .mud-button {
      width: 100%;
    }
  }
</style>