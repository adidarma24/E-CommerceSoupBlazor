@page "/admin-course/{CourseId:int}/schedule"
@layout AdminLayout

@using MyApp.BlazorUI.DTOs
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Components.Shared
@using MyApp.BlazorUI.Components.Shared.Admin

@inject ScheduleService ScheduleService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>Schedule Management</PageTitle>

<MudPaper Class="schedule-container" Elevation="1">
    <!-- Header -->
    <div class="header-section">
        <MudText Typo="Typo.h5" Class="title">
            Schedule Management for <span class="highlight">@CourseName</span>
        </MudText>

        <MudButton OnClick="OpenAddScheduleDialog" Variant="Variant.Filled" Color="Color.Success"
            StartIcon="@Icons.Material.Filled.Add">
            Add Schedule
        </MudButton>
    </div>

    <!-- Table -->
    <div class="table-wrapper">
        <MudTable Items="@Schedules" Hover="true" Loading="@_loading" Elevation="0" RowsPerPage="5">
            <HeaderContent>
                <MudTh>Date</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Available Slot</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>

            <RowTemplate>
                <MudTd>@context.ScheduleDate.ToLocalTime().ToString("dddd, dd MMM yyyy HH:mm")</MudTd>

                <MudTd Class="t">
                    @if (context.Status == "Active")
                    {
                        <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small" Label="true">
                            Active
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Error" Variant="Variant.Filled" Size="Size.Small" Label="true">
                            Inactive
                        </MudChip>
                    }
                </MudTd>

                <MudTd>@context.AvailableSlot</MudTd>

                <MudTd Class="action-buttons">
                    <MudTooltip Text="Edit Schedule">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" Size="Size.Medium"
                            OnClick="@(() => OpenEditScheduleDialog(context))" />
                    </MudTooltip>

                    <MudTooltip Text="Delete Schedule">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium"
                            OnClick="@(() => DeleteSchedule(context))" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 5, 10, 25 }" />
            </PagerContent>
        </MudTable>
    </div>
</MudPaper>

@code {
    [Parameter] public int CourseId { get; set; }

    private bool _loading = false;
    private string CourseName = "Loading...";
    private List<ScheduleViewModel> Schedules = new();

    protected override async Task OnInitializedAsync() => await LoadDataAsync();

    private async Task LoadDataAsync()
    {
        try
        {
            _loading = true;
            var response = await ScheduleService.GetSchedulesByCourseIdAsync(CourseId);

            if (response?.Success == true)
            {
                Schedules = response.Data ?? new();
                CourseName = Schedules.FirstOrDefault()?.MenuCourseName ?? "Unknown Course";
            }
            else
            {
                Snackbar.Add(response?.Message ?? "Failed to load data.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading schedules: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenAddScheduleDialog()
    {
        var parameters = new DialogParameters
        {
            [nameof(AddScheduleDialog.CourseId)] = CourseId,
            [nameof(AddScheduleDialog.CourseName)] = CourseName
        };

        var dialog = DialogService.Show<AddScheduleDialog>("Add Schedule", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadDataAsync();
            StateHasChanged();
        }
    }

    private async Task OpenEditScheduleDialog(ScheduleViewModel schedule)
    {
        var parameters = new DialogParameters
        {
            [nameof(EditScheduleDialog.Editable)] = schedule,
            [nameof(EditScheduleDialog.CourseName)] = CourseName
        };

        var dialog = DialogService.Show<EditScheduleDialog>("Edit Schedule", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
            await LoadDataAsync();
    }

    private async Task DeleteSchedule(ScheduleViewModel schedule)
    {
        bool? confirm = await DialogService.ShowMessageBox(
        title: "Confirm Delete",
        markupMessage: (MarkupString)"Are you sure you want to delete this schedule?",
        yesText: "Yes",
        cancelText: "Cancel");

        if (confirm == true)
        {
            var result = await ScheduleService.DeleteScheduleAsync(schedule.Id, schedule.ScheduleId);
            if (result.Success)
            {
                Snackbar.Add(result.Message ?? "✅ Schedule deleted successfully.", Severity.Success);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add($"❌ {result.Message}", Severity.Error);
            }
        }
    }
}

<style>
    .schedule-container {
        padding: 1.5rem;
        background-color: #fff;
        border-radius: 10px;
        width: 100%;
        height: calc(100vh - 5rem);
        overflow-y: auto;
        box-sizing: border-box;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0.75rem;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .title {
        font-weight: 600;
        color: #333;
    }

    .highlight {
        color: #1976d2;
        font-weight: 700;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    .mud-table th {
        background-color: #f7f9fa !important;
        font-weight: 600;
        text-transform: uppercase;
        color: #333;
        text-align: center;
        padding: 0.75rem;
    }

    .mud-table td {
        text-align: center;
        padding: 0.75rem;
        vertical-align: middle;
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 0.4rem;
    }

    /* RESPONSIVE */
    @@media (max-width: 768px) {
        .header-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .mud-table th,
        .mud-table td {
            font-size: 0.85rem;
            padding: 0.5rem;
        }

        .action-buttons {
            justify-content: flex-start;
        }
    }
</style>