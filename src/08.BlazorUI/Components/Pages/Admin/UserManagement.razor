@page "/admin-user"
@layout AdminLayout
@using MyApp.BlazorUI.Components.Shared.Admin
@using MyApp.BlazorUI.Components.Models
@using MyApp.BlazorUI.Services
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject UserService UserService

<PageTitle>User Management</PageTitle>

<MudPaper Elevation="1" Class="user-container">
  <div class="header-section">
    <MudText Typo="Typo.h5" Class="title">User Management</MudText>
    <MudButton OnClick="OpenAddUserDialog" Variant="Variant.Filled" Color="Color.Success"
      StartIcon="@Icons.Material.Filled.Add">
      Add User
    </MudButton>
  </div>

  <div class="table-wrapper">
    <MudTable Items="@Users" FixedHeader="true" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading"
      LoadingProgressColor="Color.Info" Dense="true" Class="user-table rounded-lg shadow-sm border" RowsPerPage="5">

      <HeaderContent>
        <MudTh>Email</MudTh>
        <MudTh>Nama</MudTh>
        <MudTh>Role</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Aksi</MudTh>
      </HeaderContent>

      <RowTemplate>
        <MudTd DataLabel="Email">@context.Email</MudTd>
        <MudTd DataLabel="Nama">@context.Name</MudTd>
        <MudTd DataLabel="Role">@context.Role</MudTd>
        <MudTd DataLabel="Status">
          @if (context.Status == UserStatus.Active)
          {
            <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">Active</MudChip>
          }
          else
          {
            <MudChip T="string" Color="Color.Error" Variant="Variant.Filled" Size="Size.Small">Inactive</MudChip>
          }
        </MudTd>
        <MudTd DataLabel="Aksi" Class="action-cell">
          <MudTooltip Text="Edit User">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Medium"
              OnClick="@(() => OpenEditUserDialog(context))" />
          </MudTooltip>

          <MudTooltip Text="Hapus User">
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium"
              OnClick="@(() => DeleteUserAsync(context))" />
          </MudTooltip>
        </MudTd>
      </RowTemplate>

      <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 5, 10, 25, 50 }" />
      </PagerContent>
    </MudTable>
  </div>
</MudPaper>

@code {
  private bool _loading;
  private List<UserModel> Users = new();

  protected override async Task OnInitializedAsync()
  {
    await LoadUsersAsync();
  }

  private async Task LoadUsersAsync()
  {
    _loading = true;
    try
    {
      Users = await UserService.GetUsersAsync();
      if (Users == null || !Users.Any())
        Snackbar.Add("Tidak ada data user ditemukan.", Severity.Info);
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Gagal memuat data user: {ex.Message}", Severity.Error);
    }
    finally
    {
      _loading = false;
    }
  }

  private async Task OpenAddUserDialog()
  {
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
    var dialog = DialogService.Show<AddUserDialog>("Add User", options);
    var result = await dialog.Result;

    if (result?.Data is true)
    {
      Snackbar.Add("‚úÖ User berhasil ditambahkan!", Severity.Success);
      await LoadUsersAsync();
    }
  }

  private async Task OpenEditUserDialog(UserModel user)
  {
    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
    var parameters = new DialogParameters { { "User", user } };
    var dialog = DialogService.Show<EditUserDialog>("Edit User", parameters, options);
    var result = await dialog.Result;

    if (result?.Data is UserModel updatedUser)
    {
      var existing = Users.FirstOrDefault(u => u.Id == updatedUser.Id);
      if (existing != null)
      {
        existing.Name = updatedUser.Name;
        existing.Email = updatedUser.Email;
        existing.Role = updatedUser.Role;
        existing.Status = updatedUser.Status;
      }

      Snackbar.Add("‚úÖ User berhasil diperbarui!", Severity.Success);
      StateHasChanged();
    }
  }

  private async Task DeleteUserAsync(UserModel user)
  {
    bool confirmed = await DialogService.ShowMessageBox(
    "Konfirmasi Hapus",
    $"Apakah kamu yakin ingin menghapus user '{user.Name}'?",
    yesText: "Ya", noText: "Batal") ?? false;

    if (!confirmed)
      return;

    var success = await UserService.DeleteUserAsync(user.Id);
    if (success)
    {
      Snackbar.Add("üóëÔ∏è User berhasil dihapus!", Severity.Success);
      await LoadUsersAsync();
    }
    else
    {
      Snackbar.Add("‚ùå Gagal menghapus user!", Severity.Error);
    }
  }
}

<style>
  .user-container {
    padding: 1.5rem;
    background-color: #fff;
    height: calc(100vh - 5rem);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    box-sizing: border-box;
  }

  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    gap: 0.5rem;
  }

  .title {
    font-weight: 600;
  }

  .table-wrapper {
    flex: 1;
    overflow-x: auto;
  }

  .user-table {
    width: 100%;
    min-width: 700px;
  }

  .action-cell {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .mud-table-head th {
    background-color: #dbffdd !important;
    text-align: center;
  }

  .mud-table-cell {
    text-align: center;
    vertical-align: middle !important;
  }

  /* RESPONSIVE */
  @@media (max-width: 768px) {
    .header-section {
      flex-direction: column;
      align-items: flex-start;
    }

    .user-table {
      min-width: 100%;
    }

    .action-cell {
      flex-direction: row;
      justify-content: flex-start;
    }
  }
</style>