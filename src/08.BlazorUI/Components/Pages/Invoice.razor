@page "/invoice"
@using Blazored.LocalStorage
@using MyApp.BlazorUI.Services
@using MyApp.BlazorUI.Models
@using MyApp.BlazorUI.Services.Interfaces
@using MyApp.BlazorUI.Components.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MyApp.BlazorUI.DTOs.Auth
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject InvoiceService InvoiceService
@inject ILocalStorageService LocalStorage

<style>
  /* --- Wrapper halaman penuh tinggi --- */
  .page-wrapper {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* --- Area konten utama --- */
  .main-content {
    flex: 1;
    overflow-x: auto;
    /* ✅ supaya tabel bisa discroll di HP */
  }

  /* --- Footer tetap di bawah --- */
  .footer {
    margin-top: auto;
    padding: 1rem;
    background-color: #f9f9f9;
    text-align: center;
    border-top: 1px solid #e0e0e0;
  }

  .custom-header {
    background-color: #5B4947;
  }

  /* --- Baris ganjil genap --- */
  .odd-row {
    background-color: #ffffff;
  }

  .even-row {
    background-color: #f5f5f5;
  }

  /* --- Tombol Details --- */
  .details-btn {
    background-color: #FABC1D !important;
    color: black !important;
    width: 11rem;
    height: 2.5rem;
    text-transform: none !important;
    text-decoration: none !important;
  }

  /* --- Teks sel --- */
  .center-cell {
    text-align: center;
  }

  .left-cell {
    text-align: left;
  }

  /* ✅ Responsif tabel */
  .table-container {
    width: 100%;
    overflow-x: auto;
    display: block;
  }

  /* ✅ Pastikan tabel tidak melewati lebar layar */
  .responsive-table {
    min-width: 700px;
    width: 100%;
    border-collapse: collapse;
  }

  /* ✅ Atur agar teks tidak kepotong di layar kecil */
  .responsive-table td,
  .responsive-table th {
    white-space: nowrap;
  }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="page-wrapper">

  <MudItem Class="px-12 mt-10">
    <MudBreadcrumbs Items="_items" Separator=">"></MudBreadcrumbs>
  </MudItem>

  @if (_loading)
  {
    <div class="d-flex align-items-center justify-content-center main-content">
      <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
      <MudText Typo="Typo.h6" Class="ml-3">Loading...</MudText>
    </div>
  }
  else
  {
    <MudItem class="px-6 py-6 main-content">
      <MudText Typo="Typo.h6" Style="color:#4F4F4F; font-weight:600">Menu Invoice</MudText>

      <!-- ✅ Bungkus tabel dalam container responsif -->
      <div class="table-container mt-4">
        <MudTable Class="responsive-table" T="InvoiceItem" Items="@invoices" Hover="true" Breakpoint="Breakpoint.Sm"
          RowClassFunc="@RowClassFunc">

          <HeaderContent>
            <MudTh Class="custom-header left-cell" style="color:white">No.</MudTh>
            <MudTh Class="custom-header center-cell" style="color:white">No. Invoice</MudTh>
            <MudTh Class="custom-header center-cell" style="color:white">Date</MudTh>
            <MudTh Class="custom-header center-cell" style="color:white">Total Course</MudTh>
            <MudTh Class="custom-header center-cell" style="color:white">Total Price</MudTh>
            <MudTh Class="custom-header center-cell" style="color:white">Action</MudTh>
          </HeaderContent>

          <RowTemplate>
            <MudTd Class="left-cell" DataLabel="No.">@(invoices.IndexOf(context) + 1)</MudTd>
            <MudTd Class="center-cell" DataLabel="No. Invoice">@context.NoInvoice</MudTd>
            <MudTd Class="center-cell" DataLabel="Date">
              @context.Date.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("en-US"))
            </MudTd>
            <MudTd Class="center-cell" DataLabel="Total Course">@context.TotalCourse</MudTd>
            <MudTd Class="center-cell" DataLabel="Total Price">IDR @context.TotalPrice.ToString("N0")</MudTd>
            <MudTd Class="center-cell">
              <MudButton Class="rounded-lg details-btn" Variant="Variant.Filled" Size="Size.Small" DropShadow="false"
                OnClick="@(() => ShowDetails(context))">
                Details
              </MudButton>
            </MudTd>
          </RowTemplate>

          <NoRecordsContent>
            <MudText Class="m-3">No invoice found.</MudText>
          </NoRecordsContent>
        </MudTable>
      </div>
    </MudItem>
  }
</MudContainer>

@code {
  private string userName = "";
  private string userEmail = "";
  private string userRole = "";

  private bool _loading;
  private bool _loaded;
  private int totalInvoices;
  private List<InvoiceItem> invoices = new();

  protected override async Task OnInitializedAsync()
  {
    _loading = true;
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender || _loaded)
      return;

    _loading = true;

    try
    {
      var authState = await AuthService.IsUserAuthenticatedAsync();
      if (!authState)
      {
        Navigation.NavigateTo("/", forceLoad: true);
      }

      string? token = null;
      try
      {
        token = await LocalStorage.GetItemAsync<string>("accessToken");
      }
      catch (Exception ex)
      {
        Console.WriteLine("⚠️ LocalStorage belum siap atau tidak tersedia: " + ex.Message);
      }

      if (!string.IsNullOrWhiteSpace(token))
      {
        invoices = (await InvoiceService.GetInvoicesUserAsync(token))
        .OrderByDescending(i => i.NoInvoice)
        .ToList();

        totalInvoices = invoices?.Count ?? 0;
      }
      else
      {
        invoices.Clear();
        totalInvoices = 0;
      }

      _loaded = true;
      StateHasChanged();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"❌ Invoices error: {ex}");
    }
    finally
    {
      _loading = false;
      StateHasChanged();
    }
  }

  private List<BreadcrumbItem> _items =
  [
  new("Home", href: "/"),
new("Invoice", href: null, disabled: true)
  ];

  private string RowClassFunc(InvoiceItem invoice, int rowNumber)
  {
    return (rowNumber % 2 == 1) ? "even-row" : "odd-row";
  }

  private void ShowDetails(InvoiceItem invoice)
  {
    Navigation.NavigateTo($"/invoice/detail/{invoice.InvoiceId}", forceLoad: true);
  }
}